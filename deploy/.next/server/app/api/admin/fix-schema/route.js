"use strict";(()=>{var e={};e.id=3939,e.ids=[3939],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},50244:(e,t,s)=>{s.r(t),s.d(t,{originalPathname:()=>A,patchFetch:()=>f,requestAsyncStorage:()=>l,routeModule:()=>m,serverHooks:()=>_,staticGenerationAsyncStorage:()=>h});var a={};s.r(a),s.d(a,{GET:()=>p,POST:()=>n,dynamic:()=>c});var r=s(49303),i=s(88716),o=s(60670),d=s(87070),u=s(20728);let c="force-dynamic";async function n(e){let t=[];try{try{await u._.$executeRaw`ALTER TABLE "Media" ADD COLUMN IF NOT EXISTS "isSold" BOOLEAN DEFAULT false`,t.push({step:"add_isSold_column",status:"success"})}catch(e){t.push({step:"add_isSold_column",status:"skipped_or_error",message:e.message})}try{await u._.$executeRaw`ALTER TABLE "Media" ADD COLUMN IF NOT EXISTS "soldAt" TIMESTAMP(3)`,t.push({step:"add_soldAt_column",status:"success"})}catch(e){t.push({step:"add_soldAt_column",status:"skipped_or_error",message:e.message})}try{await u._.$executeRaw`ALTER TABLE "Media" ADD COLUMN IF NOT EXISTS "deleteAfter" TIMESTAMP(3)`,t.push({step:"add_deleteAfter_column",status:"success"})}catch(e){t.push({step:"add_deleteAfter_column",status:"skipped_or_error",message:e.message})}let e=await u._.purchase.findMany({where:{status:"completed"},select:{id:!0,mediaId:!0,completedAt:!0}});t.push({step:"find_purchases",status:"success",count:e.length});let s=0;for(let a of e){let e=a.completedAt||new Date,r=new Date(e.getTime()+864e6);try{await u._.$executeRaw`
          UPDATE "Media" 
          SET "isSold" = true, 
              "soldAt" = ${e}::timestamp, 
              "deleteAfter" = ${r}::timestamp
          WHERE "id" = ${a.mediaId}
        `,s++}catch(e){t.push({step:"update_media",mediaId:a.mediaId,status:"error",message:e.message})}}return t.push({step:"update_media",status:"success",updatedCount:s}),d.NextResponse.json({success:!0,results:t})}catch(e){return console.error("Error fixing schema:",e),d.NextResponse.json({error:"Failed to fix schema",details:e.message,results:t},{status:500})}}async function p(e){try{let e=await u._.$queryRaw`
      SELECT column_name, data_type, is_nullable 
      FROM information_schema.columns 
      WHERE table_name = 'Media' 
      AND column_name IN ('isSold', 'soldAt', 'deleteAfter')
    `,t=await u._.purchase.count({where:{status:"completed"}});return d.NextResponse.json({columns:e,completedPurchases:t})}catch(e){return console.error("Error checking schema:",e),d.NextResponse.json({error:"Failed to check schema",details:e.message},{status:500})}}let m=new r.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/admin/fix-schema/route",pathname:"/api/admin/fix-schema",filename:"route",bundlePath:"app/api/admin/fix-schema/route"},resolvedPagePath:"C:\\Users\\chong\\AI Studio\\aimediatank-azure\\src\\app\\api\\admin\\fix-schema\\route.ts",nextConfigOutput:"standalone",userland:a}),{requestAsyncStorage:l,staticGenerationAsyncStorage:h,serverHooks:_}=m,A="/api/admin/fix-schema/route";function f(){return(0,o.patchFetch)({serverHooks:_,staticGenerationAsyncStorage:h})}},20728:(e,t,s)=>{s.d(t,{_:()=>r});let a=require("@prisma/client"),r=globalThis.prisma??new a.PrismaClient}};var t=require("../../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),a=t.X(0,[8948,5972],()=>s(50244));module.exports=a})();