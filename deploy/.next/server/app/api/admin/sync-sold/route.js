"use strict";(()=>{var e={};e.id=3891,e.ids=[3891],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},15034:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>g,patchFetch:()=>S,requestAsyncStorage:()=>p,routeModule:()=>m,serverHooks:()=>y,staticGenerationAsyncStorage:()=>h});var s={};a.r(s),a.d(s,{GET:()=>c,POST:()=>u,dynamic:()=>l});var i=a(49303),r=a(88716),d=a(60670),n=a(87070),o=a(20728);let l="force-dynamic";async function u(e){try{let e=await o._.purchase.findMany({where:{status:"completed"},select:{id:!0,mediaId:!0,completedAt:!0,media:{select:{id:!0,title:!0,isSold:!0}}}}),t=[];for(let a of e){if(a.media.isSold){t.push({mediaId:a.mediaId,title:a.media.title,status:"already_sold"});continue}let e=a.completedAt||new Date,s=new Date(e.getTime()+864e6);try{await o._.media.update({where:{id:a.mediaId},data:{isSold:!0,soldAt:e,deleteAfter:s}}),t.push({mediaId:a.mediaId,title:a.media.title,status:"marked_sold",deleteAfter:s.toISOString()})}catch(e){t.push({mediaId:a.mediaId,title:a.media.title,status:"error",error:String(e)})}}return n.NextResponse.json({success:!0,totalPurchases:e.length,results:t})}catch(e){return console.error("Error syncing sold status:",e),n.NextResponse.json({error:"Failed to sync sold status",details:String(e)},{status:500})}}async function c(e){try{let[e,t]=await Promise.all([o._.purchase.count({where:{status:"completed"}}),o._.media.count({where:{isSold:!0}})]),a=await o._.purchase.findMany({where:{status:"completed",media:{isSold:!1}},include:{media:{select:{id:!0,title:!0,isSold:!0}}}});return n.NextResponse.json({completedPurchases:e,soldMedia:t,unsyncedCount:a.length,unsynced:a.map(e=>({purchaseId:e.id,mediaId:e.mediaId,mediaTitle:e.media.title,isSold:e.media.isSold}))})}catch(e){return console.error("Error checking sync status:",e),n.NextResponse.json({error:"Failed to check sync status",details:String(e)},{status:500})}}let m=new i.AppRouteRouteModule({definition:{kind:r.x.APP_ROUTE,page:"/api/admin/sync-sold/route",pathname:"/api/admin/sync-sold",filename:"route",bundlePath:"app/api/admin/sync-sold/route"},resolvedPagePath:"C:\\Users\\chong\\AI Studio\\aimediatank-azure\\src\\app\\api\\admin\\sync-sold\\route.ts",nextConfigOutput:"standalone",userland:s}),{requestAsyncStorage:p,staticGenerationAsyncStorage:h,serverHooks:y}=m,g="/api/admin/sync-sold/route";function S(){return(0,d.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:h})}},20728:(e,t,a)=>{a.d(t,{_:()=>i});let s=require("@prisma/client"),i=globalThis.prisma??new s.PrismaClient}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),s=t.X(0,[8948,5972],()=>a(15034));module.exports=s})();